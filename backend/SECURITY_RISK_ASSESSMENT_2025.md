# 🔒 安全風險評估報告（2025年更新）

**評估日期：** 2025-01-XX  
**評估範圍：** Backend API 安全防護  
**部署環境：** EC2 (0.0.0.0/0)  
**評估人員：** 系統安全審計

---

## 📊 總體安全評分

### 當前狀態：**6.5/10** ⚠️ **中等風險** → **可改進**

### 與上次評估對比：
- **上次評分（修復前）：** 3.5/10 🔴 高風險
- **當前評分：** 6.5/10 🟡 中等風險
- **改進幅度：** +3.0（已實施多項關鍵安全措施）

---

## ✅ 已實施的安全措施

### 1. **Rate Limiting 保護** ✅ 已啟用
- **狀態：** ✅ 已啟用
- **位置：** `server.js` 第115行
- **配置：** 
  - API 限制：15分鐘內100次請求
  - 登入限制：15分鐘內5次嘗試（`auth.routes.js` 第8行）
- **保護效果：** 有效防止暴力破解和 DDoS 攻擊

### 2. **Helmet 安全標頭** ✅ 已啟用
- **狀態：** ✅ 已啟用
- **位置：** `server.js` 第30行
- **配置：** 
  - CSP（內容安全策略）
  - HSTS（強制HTTPS）
  - X-Frame-Options: DENY
  - X-Content-Type-Options: nosniff
- **保護效果：** 有效防止 XSS、Clickjacking 等攻擊

### 3. **SQL Injection 防護** ✅ 良好
- **狀態：** ✅ 已防護
- **方法：** 使用 Knex ORM 參數化查詢
- **檢查結果：** 所有 `knex.raw()` 使用均採用參數綁定，無 SQL 注入風險
- **建議：** 保持現狀，避免使用未綁定參數的 raw SQL

### 4. **密碼加密** ✅ 良好
- **狀態：** ✅ 已實作
- **方法：** bcryptjs 雜湊
- **建議：** 保持現狀

### 5. **JWT 認證機制** ✅ 已實作
- **狀態：** ✅ 已實作
- **過期時間：** 可通過 `JWT_EXPIRES_IN` 環境變數配置（默認1分鐘，建議7天）
- **Token 驗證：** 在 `middleware/auth.js` 中正確驗證
- **帳戶停用檢查：** ✅ 已實作（停用帳戶無法登入）

### 6. **權限分級系統** ✅ 已實作
- **狀態：** ✅ 已實作
- **權限層級：** 
  - 系統管理員（HR Group 成員）
  - 部門主管
  - 一般員工
- **中間件：** `isSystemAdmin`, `isDeptHead`, `isSystemAdminOrDeptHead`

### 7. **請求大小限制** ✅ 已設定
- **狀態：** ✅ 已設定
- **限制：** 10MB（JSON/URL-encoded）
- **保護效果：** 防止記憶體耗盡攻擊

---

## 🚨 剩餘風險項目（按嚴重程度排序）

### 🔴 **嚴重風險（Critical）**

#### 1. **敏感資訊日誌記錄**
- **風險等級：** 🔴 嚴重
- **影響：**
  - 密碼可能被記錄到日誌文件
  - 日誌洩露可能導致帳號被盜用
  - 違反隱私保護法規
- **當前狀態：** ⚠️ 登入時記錄完整 `req.body`（包含密碼）
- **位置：** `controllers/auth.controller.js` 第11行
- **問題代碼：**
  ```javascript
  console.log('Request body:', req.body); // 包含 password 欄位
  ```
- **修復難度：** ⭐ 極易（5分鐘）
- **建議修復：**
  ```javascript
  const { password, ...safeBody } = req.body;
  console.log('Request body:', safeBody);
  ```

#### 2. **輸入驗證不足**
- **風險等級：** 🔴 嚴重
- **影響：**
  - 資料注入攻擊
  - 格式錯誤導致系統異常
  - 惡意輸入導致業務邏輯錯誤
- **當前狀態：** ⚠️ 只有基本空值檢查
- **問題：**
  - `express-validator` 已安裝但**未使用**
  - 無輸入 sanitization
  - 無長度限制驗證
  - 無格式驗證（email、日期、數字等）
  - 無特殊字符過濾
- **影響範圍：**
  - 所有 controllers（user, leave, approval, admin 等）
  - 可能導致：
    - Email 格式錯誤導致郵件發送失敗
    - 日期格式錯誤導致邏輯錯誤
    - 數字類型錯誤導致計算錯誤
    - XSS 攻擊（雖然有 Helmet，但輸入驗證仍是必要防線）
- **修復難度：** ⭐⭐ 中等（需要創建驗證規則並在路由中應用）
- **實際工作量評估：**
  - **快速實施（關鍵端點）：** 1-2小時（登入、創建用戶、創建申請等5-8個關鍵端點）
  - **完整實施（所有端點）：** 3-4小時（所有約24個 create/update 端點）
- **建議：** 
  - 先對關鍵端點加入驗證（登入、創建用戶、創建申請）
  - 逐步擴展到其他端點
  - 可以創建可重用的驗證規則文件以提高效率

#### 3. **檔案上傳驗證不足**
- **風險等級：** 🔴 嚴重
- **影響：**
  - 惡意檔案上傳（病毒、木馬）
  - 檔案類型偽造（MIME type 可被偽造）
  - 檔案大小炸彈攻擊
- **當前狀態：** ⚠️ 有基本驗證但不足
- **問題：**
  - 只檢查 MIME type 和副檔名（可偽造）
  - 未檢查檔案內容（magic bytes/檔案頭）
  - 未掃描惡意檔案
  - 未限制檔案數量（多檔案上傳可上傳100個檔案）
- **位置：** 
  - `middleware/upload.js`（假期文件，最多100個檔案）
  - `middleware/documentUpload.js`（員工文件，最多50個檔案）
- **修復難度：** ⭐⭐ 中等（需要加入檔案內容檢查，約2-4小時）
- **建議：** 
  - 使用 `file-type` 或類似套件檢查檔案內容（magic bytes）
  - 考慮加入病毒掃描（如 ClamAV）
  - 限制多檔案上傳數量（建議10-20個）

---

### 🟠 **高風險（High）**

#### 4. **Health Check 端點資訊洩露**
- **風險等級：** 🟠 高
- **影響：**
  - 系統資訊洩露（系統名稱、版本等）
  - 可用於系統探測和攻擊規劃
- **當前狀態：** ⚠️ 公開訪問，包含系統訊息
- **位置：** `server.js` 第148-150行
- **問題代碼：**
  ```javascript
  app.get('/api/health', (req, res) => {
    res.json({ status: 'OK', message: 'Leave Administration System API' });
  });
  ```
- **修復難度：** ⭐ 極易（1分鐘）
- **建議修復：**
  ```javascript
  app.get('/api/health', (req, res) => {
    res.json({ status: 'OK' }); // 移除詳細訊息
  });
  ```

#### 5. **無 CSRF 保護**
- **風險等級：** 🟠 高
- **影響：**
  - 跨站請求偽造攻擊
  - 未授權操作（如：惡意網站代表用戶執行操作）
- **當前狀態：** ❌ 無 CSRF token 驗證
- **影響範圍：** 所有需要認證的 POST/PUT/DELETE 請求
- **修復難度：** ⭐⭐ 中等（需要前端和後端配合，約2-3小時）
- **建議：** 
  - 安裝 `csurf` 或使用 `csrf` 套件
  - 在需要保護的路由中加入 CSRF token 驗證
  - 前端需要發送 CSRF token

#### 6. **CORS 配置在開發模式過於寬鬆**
- **風險等級：** 🟠 高（僅在生產環境配置錯誤時）
- **影響：**
  - 任何網站都可以呼叫你的 API
  - CSRF 攻擊風險增加
- **當前狀態：** ⚠️ 開發模式允許所有來源
- **位置：** `server.js` 第81-82行
- **問題代碼：**
  ```javascript
  if (process.env.NODE_ENV !== 'production' && !process.env.ALLOWED_ORIGINS) {
    return callback(null, true); // 允許所有來源
  }
  ```
- **修復難度：** ⭐ 極易
- **建議：** 
  - 生產環境務必設定 `NODE_ENV=production` 和 `ALLOWED_ORIGINS`
  - 考慮在開發環境也限制允許的來源（使用環境變數）

#### 7. **JWT Token 過期時間配置不一致**
- **風險等級：** 🟠 高
- **影響：**
  - Token 過期時間過短導致用戶體驗差
  - Token 過期時間過長增加被盜用風險
- **當前狀態：** ⚠️ 默認值為1分鐘（過短），但可通過環境變數配置
- **位置：** `utils/jwt.js` 第13行
- **問題代碼：**
  ```javascript
  { expiresIn: process.env.JWT_EXPIRES_IN || '1m' } // 默認1分鐘太短
  ```
- **修復難度：** ⭐ 極易（5分鐘）
- **建議：** 
  - 將默認值改為 `'7d'`（7天）或 `'24h'`（24小時）
  - 確保生產環境明確設定 `JWT_EXPIRES_IN` 環境變數

#### 8. **錯誤處理可能洩露敏感資訊**
- **風險等級：** 🟠 高（僅在開發模式）
- **影響：**
  - 堆疊追蹤可能洩露系統結構
  - 資料庫錯誤可能洩露表結構
- **當前狀態：** ⚠️ 開發模式回傳詳細錯誤資訊
- **位置：** 多個 controllers
- **問題示例：**
  ```javascript
  details: process.env.NODE_ENV === 'development' ? error.stack : undefined
  ```
- **修復難度：** ⭐⭐ 中等（需要檢查所有 controllers，約1-2小時）
- **建議：** 
  - 生產環境確保不返回堆疊追蹤
  - 記錄詳細錯誤到日誌，但只返回通用錯誤訊息給用戶

---

### 🟡 **中等風險（Medium）**

#### 9. **無密碼策略強制**
- **風險等級：** 🟡 中等
- **影響：**
  - 弱密碼容易被破解
  - 帳號安全風險
- **當前狀態：** ⚠️ 只有基本長度檢查（>=6字符）
- **位置：** `controllers/auth.controller.js` 第135行
- **問題：**
  - 無複雜度要求（大小寫、數字、特殊字符）
  - 無常見弱密碼檢查
  - 只有前端驗證（可繞過）
- **修復難度：** ⭐⭐ 中等（約1-2小時）
- **建議：** 
  - 後端強制密碼複雜度要求
  - 檢查常見弱密碼列表
  - 建議：至少8字符，包含大小寫字母、數字

#### 10. **無請求 ID 追蹤**
- **風險等級：** 🟡 中等
- **影響：**
  - 難以追蹤異常請求
  - 除錯困難
  - 無法關聯相關請求
- **當前狀態：** ⚠️ 有日誌但無唯一請求 ID
- **修復難度：** ⭐⭐ 中等（約1小時）
- **建議：** 
  - 使用 `uuid` 為每個請求生成唯一 ID
  - 在日誌和錯誤回應中包含請求 ID
  - 方便追蹤和除錯

#### 11. **檔案上傳路徑安全**
- **風險等級：** 🟡 中等
- **影響：**
  - 雖然使用時間戳，但理論上仍可能被猜測
  - 檔案路徑可能暴露目錄結構
- **當前狀態：** ⚠️ 使用時間戳 + 隨機數生成檔名（相對安全）
- **位置：** `middleware/upload.js` 第23行
- **建議：** 考慮使用 UUID 生成檔名（更安全）

---

### 🟢 **低風險（Low）**

#### 12. **無檔案下載速度限制**
- **風險等級：** 🟢 低
- **影響：** 大檔案下載可能耗盡頻寬
- **建議：** 可選加入下載速度限制

#### 13. **無 API 版本控制**
- **風險等級：** 🟢 低
- **影響：** 未來 API 變更可能破壞相容性
- **建議：** 可選加入 API 版本前綴（如 `/api/v1/`）

---

## 📋 詳細風險分析

### 攻擊向量分析

| 攻擊類型 | 風險等級 | 當前防護 | 建議措施 | 狀態 |
|---------|---------|---------|---------|------|
| **暴力破解** | 🔴 嚴重 | ✅ 已防護（Rate Limiting） | 保持現狀 | ✅ 已修復 |
| **DDoS** | 🔴 嚴重 | ✅ 已防護（Rate Limiting） | 保持現狀 | ✅ 已修復 |
| **XSS** | 🔴 嚴重 | ✅ 已防護（Helmet CSP） | 加入輸入驗證 | ⚠️ 部分防護 |
| **SQL Injection** | 🟢 低 | ✅ 已防護（Knex ORM） | 保持現狀 | ✅ 已修復 |
| **檔案上傳攻擊** | 🔴 嚴重 | ⚠️ 部分防護 | 檢查檔案內容 | ⚠️ 需改進 |
| **CSRF** | 🟠 高 | ❌ 無 | 加入 CSRF token | ❌ 未修復 |
| **資訊洩露** | 🟠 高 | ⚠️ 部分防護 | 清理日誌和錯誤訊息 | ⚠️ 需改進 |
| **路徑遍歷** | 🟢 低 | ✅ 已防護（時間戳檔名） | 考慮使用 UUID | ✅ 已防護 |
| **敏感資料洩露** | 🔴 嚴重 | ❌ 無 | 移除密碼日誌記錄 | ❌ 未修復 |

---

## 🛠️ 立即修復清單（優先級排序）

### ⚡ **立即修復（1小時內）** - 嚴重風險

1. **移除敏感資訊日誌記錄** ⏱️ 5分鐘
   ```javascript
   // backend/controllers/auth.controller.js 第11行
   // 修改前：
   console.log('Request body:', req.body);
   
   // 修改後：
   const { password, ...safeBody } = req.body;
   console.log('Request body:', safeBody);
   ```

2. **簡化 Health Check 端點** ⏱️ 1分鐘
   ```javascript
   // backend/server.js 第148行
   // 修改前：
   res.json({ status: 'OK', message: 'Leave Administration System API' });
   
   // 修改後：
   res.json({ status: 'OK' });
   ```

3. **調整 JWT 過期時間默認值** ⏱️ 5分鐘
   ```javascript
   // backend/utils/jwt.js 第13行
   // 修改前：
   { expiresIn: process.env.JWT_EXPIRES_IN || '1m' }
   
   // 修改後：
   { expiresIn: process.env.JWT_EXPIRES_IN || '7d' }
   ```

### 🔧 **短期修復（1-2天）** - 高風險

4. **加入輸入驗證** ⏱️ 4-8小時
   - 在所有 controllers 中使用 `express-validator`
   - 驗證 email、日期、數字格式
   - 設定長度限制
   - 過濾特殊字符

5. **加強檔案上傳驗證** ⏱️ 2-4小時
   - 安裝並使用 `file-type` 套件檢查檔案內容（magic bytes）
   - 限制多檔案上傳數量（10-20個）
   - 考慮加入病毒掃描

6. **加入 CSRF 保護** ⏱️ 2-3小時
   - 安裝 `csurf` 套件
   - 在需要保護的路由中加入 CSRF token
   - 前端發送 CSRF token

### 📅 **中期改進（1週內）** - 中等風險

7. **強制密碼策略** ⏱️ 1-2小時
   - 後端驗證密碼複雜度
   - 檢查常見弱密碼列表

8. **加入請求 ID 追蹤** ⏱️ 1小時
   - 使用 UUID 生成請求 ID
   - 在日誌和錯誤回應中包含請求 ID

9. **改進錯誤處理** ⏱️ 1-2小時
   - 確保生產環境不返回堆疊追蹤
   - 記錄詳細錯誤到日誌，返回通用錯誤訊息

---

## 📊 安全評分對比

### 當前狀態

| 安全項目 | 評分 | 狀態 | 備註 |
|---------|------|------|------|
| Rate Limiting | 9/10 | ✅ 已啟用 | 良好 |
| 登入保護 | 9/10 | ✅ 已啟用 | 良好 |
| 安全標頭（Helmet） | 9/10 | ✅ 已啟用 | 良好 |
| 輸入驗證 | 3/10 | ⚠️ 不足 | express-validator 未使用 |
| SQL Injection | 8/10 | ✅ 已防護 | Knex ORM |
| 檔案上傳 | 5/10 | ⚠️ 部分防護 | 需檢查檔案內容 |
| CORS | 7/10 | ⚠️ 開發模式寬鬆 | 生產環境需正確配置 |
| 認證授權 | 8/10 | ✅ 已實作 | JWT + 權限分級 |
| 密碼加密 | 8/10 | ✅ 已實作 | bcryptjs |
| 資訊洩露防護 | 4/10 | ⚠️ 需改進 | 日誌記錄密碼 |
| CSRF 保護 | 0/10 | ❌ 無 | 需加入 |
| **總分** | **6.5/10** | ⚠️ **中等風險** | **可改進** |

### 完成所有建議修復後

| 安全項目 | 預期評分 | 狀態 |
|---------|---------|------|
| Rate Limiting | 9/10 | ✅ 保持 |
| 登入保護 | 9/10 | ✅ 保持 |
| 安全標頭 | 9/10 | ✅ 保持 |
| 輸入驗證 | 8/10 | ✅ 改進 |
| SQL Injection | 8/10 | ✅ 保持 |
| 檔案上傳 | 8/10 | ✅ 改進 |
| CORS | 9/10 | ✅ 改進 |
| 認證授權 | 9/10 | ✅ 改進 |
| 密碼加密 | 9/10 | ✅ 改進 |
| 資訊洩露防護 | 9/10 | ✅ 改進 |
| CSRF 保護 | 8/10 | ✅ 新增 |
| **預期總分** | **8.5/10** | ✅ **低風險** |

---

## 🎯 攻擊場景模擬

### 場景 1：敏感資訊洩露攻擊
**攻擊者行為：**
1. 攻擊者取得伺服器日誌訪問權限
2. 從日誌中提取用戶密碼（明文或可推測）

**當前防護：** ❌ 無（密碼被記錄）  
**修復後：** ✅ 日誌中不包含密碼

---

### 場景 2：檔案上傳攻擊
**攻擊者行為：**
```bash
# 偽造檔案類型上傳惡意檔案
curl -X POST http://your-server.com/api/documents/upload \
  -H "Authorization: Bearer <token>" \
  -F "file=@malware.exe" \
  -H "Content-Type: application/pdf" # 偽造 MIME type
```

**當前防護：** ⚠️ 只檢查 MIME type（可偽造）  
**修復後：** ✅ 檢查檔案內容（magic bytes）

---

### 場景 3：CSRF 攻擊
**攻擊者行為：**
1. 誘導用戶訪問惡意網站
2. 惡意網站發送請求到目標 API（利用用戶已登入狀態）
3. 執行未授權操作（如：更改密碼、刪除資料）

**當前防護：** ❌ 無  
**修復後：** ✅ CSRF token 驗證

---

### 場景 4：輸入驗證繞過攻擊
**攻擊者行為：**
```javascript
// 發送惡意輸入
{
  "email": "<script>alert('XSS')</script>@example.com",
  "start_date": "invalid-date",
  "total_days": "999999999"
}
```

**當前防護：** ⚠️ 只有基本空值檢查  
**修復後：** ✅ express-validator 驗證格式和範圍

---

## 📈 風險矩陣

| 攻擊難度 | 影響程度 | 風險等級 | 當前防護 | 建議優先級 |
|---------|---------|---------|---------|-----------|
| 極易 | 嚴重 | 🔴 嚴重 | ⚠️ 部分 | **P0 - 立即修復** |
| 容易 | 高 | 🟠 高 | ⚠️ 部分 | **P1 - 短期修復** |
| 中等 | 中等 | 🟡 中等 | ⚠️ 部分 | **P2 - 中期改進** |
| 困難 | 低 | 🟢 低 | ✅ 已防護 | P3 - 可選改進 |

---

## ✅ 已實作的安全措施（總結）

1. ✅ **Rate Limiting** - 已啟用（API 和登入）
2. ✅ **Helmet 安全標頭** - 已啟用
3. ✅ **SQL Injection 防護** - 使用 Knex ORM
4. ✅ **密碼加密** - 使用 bcryptjs
5. ✅ **JWT 認證** - Token 基礎認證
6. ✅ **權限分級** - 系統管理員、部門主管
7. ✅ **請求大小限制** - 10MB 限制
8. ✅ **檔案類型驗證** - MIME type 和副檔名
9. ✅ **檔案大小限制** - 5MB/8MB
10. ✅ **帳戶停用檢查** - 停用帳戶無法登入

---

## ❌ 缺少或需改進的安全措施

1. ❌ **敏感資訊日誌清理** - 密碼被記錄
2. ❌ **輸入驗證** - express-validator 未使用
3. ❌ **CSRF 保護** - 無
4. ❌ **檔案內容檢查** - 只檢查 MIME type
5. ❌ **密碼策略強制** - 只有基本長度檢查
6. ❌ **請求 ID 追蹤** - 無
7. ⚠️ **錯誤處理** - 開發模式洩露資訊
8. ⚠️ **Health Check** - 洩露系統資訊

---

## 🚀 快速修復指南

### 步驟 1：立即修復嚴重風險（15分鐘）

```javascript
// 1. 移除敏感資訊日誌記錄
// backend/controllers/auth.controller.js
const { password, ...safeBody } = req.body;
console.log('Request body:', safeBody);

// 2. 簡化 Health Check
// backend/server.js
app.get('/api/health', (req, res) => {
  res.json({ status: 'OK' });
});

// 3. 調整 JWT 過期時間
// backend/utils/jwt.js
{ expiresIn: process.env.JWT_EXPIRES_IN || '7d' }
```

### 步驟 2：短期修復（1-2天）

- 加入輸入驗證（express-validator）
- 加強檔案上傳驗證（file-type）
- 加入 CSRF 保護（csurf）

### 步驟 3：中期改進（1週）

- 強制密碼策略
- 加入請求 ID 追蹤
- 改進錯誤處理

---

## 📞 緊急應變計劃

如果發現攻擊：

1. **立即啟用所有安全措施**（如果尚未啟用）
2. **檢查日誌找出攻擊來源**
3. **封鎖惡意 IP**（可使用 `ALLOWED_IPS` 環境變數）
4. **更改所有密碼和秘鑰**（JWT_SECRET、資料庫密碼等）
5. **通知相關人員**
6. **檢查是否有資料外洩**
7. **修復被利用的漏洞**

---

## 🎯 結論

### 當前狀態：**中等風險，可部署但需改進**

**主要改進點：**
- ✅ 已實施關鍵安全措施（Rate Limiting、Helmet）
- ⚠️ 需立即修復敏感資訊日誌記錄
- ⚠️ 需加入輸入驗證
- ⚠️ 需加強檔案上傳驗證
- ⚠️ 需加入 CSRF 保護

### 建議行動計劃：

1. **本週內：** 完成立即修復項目（敏感資訊日誌、Health Check、JWT 配置）
2. **兩週內：** 完成短期修復項目（輸入驗證、檔案驗證、CSRF）
3. **一個月內：** 完成中期改進項目（密碼策略、請求追蹤、錯誤處理）

**完成所有建議修復後，預期安全評分可達到 8.5/10（低風險）**

---

**最後更新：** 2025-01-XX  
**下次評估建議：** 完成修復後 1 個月，或重大更新後立即評估

